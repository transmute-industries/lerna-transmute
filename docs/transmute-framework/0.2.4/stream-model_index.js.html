<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>stream-model/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="EventStore.module.exports.html">module.exports</a></li><li><a href="EventStoreFactory.module.exports.html">module.exports</a></li><li><a href="module-src_decentralized-storage-TransmuteIpfsAdapter.html">TransmuteIpfsAdapter</a></li><li><a href="module-src_event-store-factory-EventStoreFactory.html">EventStoreFactory</a></li><li><a href="module-src_event-store-EventStore.html">EventStore</a></li><li><a href="module-src_stream-model-StreamModel.html">StreamModel</a></li><li><a href="StreamModel.module.exports.html">module.exports</a></li><li><a href="TransmuteIpfsAdapter.module.exports.html">module.exports</a></li></ul><h3>Modules</h3><ul><li><a href="module-src_decentralized-storage.html">src/decentralized-storage</a></li><li><a href="module-src_event-store.html">src/event-store</a></li><li><a href="module-src_event-store-factory.html">src/event-store-factory</a></li><li><a href="module-src_stream-model.html">src/stream-model</a></li><li><a href="module-TransmuteFramework.html">TransmuteFramework</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">stream-model/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * A module for applying events to reducers and creating stream models
 * @module src/stream-model
 */

/** @class StreamModel */
module.exports = class StreamModel {
  /**
   * Creates a new StreamModel.
   * @constructor
   * @memberof StreamModel
   * @param {EventStore} eventStore - EventStore where events will originate from.
   * @param {function} filter - Filter function for filtering events.
   * @param {function} reducer - Reducer function for reducing events to a model.
   * @param {Object} state - State object that is used with the reducer.
   */
  constructor(eventStore, filter, reducer, state) {
    eventStore.requireInstance();
    this.eventStore = eventStore;
    this.filter = filter;
    this.reducer = reducer;
    this.state = state || {
      contractAddress: this.eventStore.eventStoreContractInstance.address,
      model: {},
      lastIndex: null
    };
  }

  /**
   * Applies an event to this StreamModel's reducer
   * @function
   * @memberof StreamModel
   * @name applyEvent
   * @param {Object} event - An event object.
   */
  applyEvent(event) {
    this.state.model = this.reducer(this.state.model, event);
    this.state.lastIndex = event.index;
  }

  /**
   * Applies an array of events to this StreamModel's reducer
   * @function
   * @memberof StreamModel
   * @name applyEvents
   * @param {Array.&lt;Object>} events - An array event objects.
   */
  applyEvents(events) {
    events.filter(this.filter).map(this.applyEvent.bind(this));
  }

  /**
   * Checks EventStore for events which have not been applied to the StreamModel and applies them.
   * @function
   * @memberof StreamModel
   * @name sync
   */
  async sync() {
    const web3 = this.eventStore.web3;
    const eventCount = (await this.eventStore.eventStoreContractInstance.count.call()).toNumber();
    if (eventCount === 0) {
      return;
    }
    if (
      this.state.lastIndex === null ||
      this.state.lastIndex + 1 &lt; eventCount
    ) {
      let start = this.state.lastIndex === null ? 0 : this.state.lastIndex + 1;
      let end = eventCount - 1;
      const updates = await this.eventStore.getSlice(start, end);
      this.applyEvents(updates);
    }
  }
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Aug 09 2018 10:35:38 GMT-0500 (CDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
