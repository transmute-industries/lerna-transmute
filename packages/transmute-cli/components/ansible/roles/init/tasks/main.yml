---
- name: Sourcing {{ ansible_env.HOME }}/.transmute/.env
  shell: "source {{ ansible_env.HOME }}/.transmute/.env"
  args:
    executable: /bin/bash

- name: Waiting for kube-dns in kube-system
  shell: $(npm root -g)/transmute-cli/scripts/w8s/ready.w8 kube-dns kube-system
  changed_when: no

- name: Outputting kubectl configuration
  shell: kubectl config view
  changed_when: no

- name: Listing cluster resources for all namespaces
  shell: kubectl get pods --all-namespaces
  changed_when: no

- name: Initializing helm
  shell: helm init --wait

- name: helm repo add transmute-charts
  shell: "helm repo add transmute-charts http://charts.transmute.network"

- name: USE_STRICT_W8
  shell: "$(npm root -g)/transmute-cli/scripts/w8s/ready.w8 tiller-deploy kube-system"

- name: kubectl get pods -n kube-system
  shell: "kubectl get pods -n kube-system"

- name: minikube_ip
  shell: "minikube ip"
  register: minikube_ip

- name: add transmute.minikube to /etc/hosts
  lineinfile:
    path: /etc/hosts
    line: '{{ minikube_ip.stdout }} transmute.minikube'
  become: yes